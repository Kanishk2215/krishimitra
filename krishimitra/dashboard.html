<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Krishimitra</title>

    <!-- Tailwind CSS with custom configuration -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Custom Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4CAF50',
                        secondary: '#2196F3',
                        accent: '#FF9800',
                    }
                }
            }
        }

        // Suppress CDN warning in production
        const originalWarn = console.warn;
        console.warn = function (...args) {
            if (args[0] && args[0].includes('cdn.tailwindcss.com')) {
                return; // Suppress Tailwind CDN warning
            }
            originalWarn.apply(console, args);
        };
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
        }
    </style>

    <script src="config.js"></script>
    <script>
        // Global definition of ML_URL for the entire app
        const ML_URL = getMlUrl();
        console.log("KrishiMitra ML Service URL:", ML_URL);
    </script>

    <style>
        .glass-nav {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(22, 163, 74, 0.1);
        }

        .feature-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        /* Disease Analysis Enhancements */
        .damage-bar {
            display: flex;
            height: 24px;
            border-radius: 99px;
            overflow: hidden;
            background: #f1f5f9;
        }

        .damage-bar .affected {
            background: linear-gradient(90deg, #ef4444, #f87171);
            height: 100%;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 800;
            color: white;
        }

        .damage-bar .healthy {
            background: linear-gradient(90deg, #22c55e, #4ade80);
            height: 100%;
        }

        .sticky-quick-bar {
            position: sticky;
            top: -32px;
            /* Pull into padding of parent */
            z-index: 100;
            margin: 0 -32px 24px -32px;
            padding: 12px 32px;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }

        .econ-card-premium {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            box-shadow: 0 20px 25px -5px rgba(15, 23, 42, 0.1);
        }
    </style>
</head>

<body class="min-h-screen pb-20">
    <!-- Navbar -->
    <nav class="glass-nav sticky top-0 z-50 px-4 py-3">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üåæ</span>
                <span class="text-xl font-bold text-green-800">Krishimitra</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="showSection('profile')" class="p-2 hover:bg-green-50 rounded-full transition-colors">
                    <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold"
                        id="userInitial">K</div>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Section -->
    <main id="dashboardSection" class="max-w-6xl mx-auto p-4 md:p-8 space-y-8">
        <!-- Welcome Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="space-y-1">
                <h1 class="text-3xl font-bold text-slate-800">Namaste, <span id="welcomeName"
                        class="text-green-600">Farmer</span>!</h1>
                <p class="text-slate-500 font-medium">Here's what's happening on your farm today.</p>
            </div>
            <button onclick="planMyCrop()" id="planCropBtn"
                class="px-8 py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-2xl shadow-lg shadow-green-100 transition-all transform hover:scale-[1.05] active:scale-[0.95] flex items-center gap-2">
                ‚ú® Plan My Crop
            </button>
        </div>

        <!-- Weather Section -->
        <div onclick="showModal('weatherModal')"
            class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-6 md:p-8 text-white shadow-xl relative overflow-hidden cursor-pointer hover:scale-[1.01] transition-transform">
            <div class="relative z-10 flex flex-col md:flex-row justify-between gap-8">
                <div>
                    <p class="text-blue-100 font-medium mb-1" id="weatherCity">Live Weather - Nashik</p>
                    <div class="flex items-center gap-4">
                        <span class="text-6xl font-bold" id="weatherTemp">28¬∞C</span>
                        <div class="text-4xl" id="weatherIcon">‚òÄÔ∏è</div>
                    </div>
                    <p class="mt-2 text-blue-50 font-medium" id="weatherTips">Perfect conditions for pesticide spraying.
                    </p>
                    <p class="text-[10px] text-blue-200 uppercase font-bold tracking-widest mt-1 italic"
                        id="weatherDesc">Clear Sky</p>
                </div>
                <div id="weatherForecastGrid"
                    class="grid grid-cols-3 gap-6 border-t md:border-t-0 md:border-l border-white/20 pt-6 md:pt-0 md:pl-8">
                    <div class="text-center">
                        <p class="text-xs text-blue-200 uppercase font-bold tracking-wider mb-2">Tomorrow</p>
                        <p class="text-xl font-bold">27¬∞C</p>
                        <p>‚õÖ</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-blue-200 uppercase font-bold tracking-wider mb-2">Wednesday</p>
                        <p class="text-xl font-bold">26¬∞C</p>
                        <p>üåßÔ∏è</p>
                    </div>
                    <div class="text-center text-blue-200">
                        <p class="text-xs uppercase font-bold tracking-wider mb-2">Thursday</p>
                        <p class="text-xl font-bold">25¬∞C</p>
                        <p>‚òÅÔ∏è</p>
                    </div>
                </div>
            </div>
            <!-- Decorative circle -->
            <div class="absolute -right-20 -top-20 w-64 h-64 bg-white/10 rounded-full"></div>
        </div>

        <!-- Crop Recommendations -->
        <section class="space-y-4">
            <div class="flex justify-between items-end">
                <h2 class="text-xl font-bold text-slate-800">Smart Crop Matches</h2>
                <a href="javascript:void(0)" onclick="toggleDetailedAnalysis()"
                    class="text-sm font-semibold text-green-600 hover:underline">See detailed analysis</a>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Card 1 -->
                <div onclick="showCropDetail('Soybean', '600-1000 mm')"
                    class="feature-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-4 cursor-pointer">
                    <div class="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center text-2xl">üå±</div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg">Soybean</h3>
                        <p class="text-sm text-slate-500 font-medium">92% Match ‚Ä¢ Kharif Season</p>
                    </div>
                    <div class="pt-4 border-t border-slate-50 flex justify-between items-center">
                        <span class="text-green-600 font-bold">‚Çπ45k / acre</span>
                        <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg">90 Days</span>
                    </div>
                </div>
                <!-- Card 2 -->
                <div onclick="showCropDetail('Cotton', '750-1200 mm')"
                    class="feature-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-4 cursor-pointer">
                    <div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-2xl">‚òÅÔ∏è</div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg">Cotton</h3>
                        <p class="text-sm text-slate-500 font-medium">88% Match ‚Ä¢ Kharif Season</p>
                    </div>
                    <div class="pt-4 border-t border-slate-50 flex justify-between items-center">
                        <span class="text-blue-600 font-bold">‚Çπ60k / acre</span>
                        <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg">160 Days</span>
                    </div>
                </div>
                <!-- Card 3 -->
                <div onclick="showCropDetail('Tur Dal', '600-900 mm')"
                    class="feature-card bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-4 cursor-pointer">
                    <div class="w-12 h-12 bg-yellow-100 rounded-2xl flex items-center justify-center text-2xl">üåæ</div>
                    <div>
                        <h3 class="font-bold text-slate-800 text-lg">Tur Dal</h3>
                        <p class="text-sm text-slate-500 font-medium">85% Match ‚Ä¢ Long Term</p>
                    </div>
                    <div class="pt-4 border-t border-slate-50 flex justify-between items-center">
                        <span class="text-yellow-600 font-bold">‚Çπ50k / acre</span>
                        <span class="text-xs font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg">150 Days</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick Actions -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <button onclick="showModal('diseaseModal')"
                class="flex flex-col items-center justify-center p-6 bg-white rounded-3xl border border-slate-100 feature-card text-slate-700 font-bold">
                <span class="text-3xl mb-2">üè•</span>
                Disease Detection
            </button>
            <button onclick="showModal('marketModal')"
                class="flex flex-col items-center justify-center p-6 bg-white rounded-3xl border border-slate-100 feature-card text-slate-700 font-bold">
                <span class="text-3xl mb-2">üí∞</span>
                Market
            </button>
            <button onclick="showModal('fertilizerModal')"
                class="flex flex-col items-center justify-center p-6 bg-white rounded-3xl border border-slate-100 feature-card text-slate-700 font-bold">
                <span class="text-3xl mb-2">üß™</span>
                Fertilizer Plan
            </button>
            <button onclick="showModal('marketPlannerModal')"
                class="flex flex-col items-center justify-center p-6 bg-white rounded-3xl border border-slate-100 feature-card text-slate-700 font-bold relative overflow-hidden group">
                <div class="absolute inset-0 bg-yellow-400 opacity-0 group-hover:opacity-10 transition-opacity"></div>
                <span class="text-3xl mb-2">üöú</span>
                Market Planner
            </button>

        </div>
    </main>

    <!-- Profile Section (Hidden) -->
    <main id="profileSection"
        class="hidden max-w-2xl mx-auto p-4 md:p-8 space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
        <button onclick="showSection('dashboard')"
            class="text-sm font-bold text-green-600 flex items-center gap-1 mb-4">
            ‚Üê Back to Dashboard
        </button>

        <div class="bg-white rounded-[2rem] p-8 border border-slate-100 shadow-xl space-y-8">
            <div class="flex flex-col items-center text-center">
                <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-green-700 rounded-full flex items-center justify-center text-4xl text-white font-bold mb-4 shadow-lg shadow-green-200"
                    id="profileBadge">
                    K
                </div>
                <h2 class="text-2xl font-bold text-slate-800" id="profileName">Farmer Singh</h2>
                <p class="text-slate-400 font-medium">Verified Krishimitra Member</p>
            </div>

            <div class="space-y-6">
                <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-4">
                    <div class="p-2 bg-white rounded-xl shadow-sm italic">üì±</div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Mobile Number</p>
                        <p class="font-bold text-slate-700" id="profilePhone">+91 ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-4">
                    <div class="p-2 bg-white rounded-xl shadow-sm italic">üìç</div>
                    <div class="flex-1">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Location</p>
                        <p class="font-bold text-slate-700" id="profileLocation">Loading...</p>
                    </div>
                    <button onclick="showModal('locationSettingsModal')"
                        class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold rounded-lg transition-all">
                        ‚úèÔ∏è Edit
                    </button>
                </div>
                <div class="p-4 bg-slate-50 rounded-2xl flex items-center gap-4">
                    <div class="p-2 bg-white rounded-xl shadow-sm italic">üöú</div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Account Status</p>
                        <p class="font-bold text-green-600">Active & Secured</p>
                    </div>
                </div>
            </div>

            <button onclick="logout()"
                class="w-full py-4 bg-red-50 hover:bg-red-100 text-red-600 font-bold rounded-2xl transition-all">
                Logout from System
            </button>
        </div>
    </main>

    <!-- üìà Price Trends Modal (NEW) -->
    <div id="trendsModal"
        class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-10 shadow-2xl animate-in zoom-in-95 duration-300">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-2xl font-bold text-slate-800">Historical Price Trends</h3>
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">6-Month Market Analysis
                    </p>
                </div>
                <button onclick="closeModal('trendsModal')"
                    class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>

            <div class="space-y-8">
                <!-- Trend Chart Simulation -->
                <div class="h-48 flex items-end justify-between gap-2 px-4 border-b border-slate-100 pb-2">
                    <div class="flex flex-col items-center flex-1 h-full justify-end group cursor-pointer">
                        <div class="w-full bg-green-200 rounded-t-xl group-hover:bg-green-500 transition-colors relative"
                            style="height: 60%">
                            <div
                                class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                ‚Çπ4.2k</div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 mt-2">JAN</p>
                    </div>
                    <div class="flex flex-col items-center flex-1 h-full justify-end group cursor-pointer">
                        <div class="w-full bg-green-300 rounded-t-xl group-hover:bg-green-500 transition-colors relative"
                            style="height: 75%">
                            <div
                                class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                ‚Çπ4.8k</div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 mt-2">FEB</p>
                    </div>
                    <div class="flex flex-col items-center flex-1 h-full justify-end group cursor-pointer">
                        <div class="w-full bg-green-400 rounded-t-xl group-hover:bg-green-500 transition-colors relative"
                            style="height: 65%">
                            <div
                                class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                ‚Çπ4.5k</div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 mt-2">MAR</p>
                    </div>
                    <div class="flex flex-col items-center flex-1 h-full justify-end group cursor-pointer">
                        <div class="w-full bg-green-500 rounded-t-xl group-hover:bg-green-600 transition-colors relative"
                            style="height: 85%">
                            <div
                                class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                ‚Çπ5.2k</div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 mt-2">APR</p>
                    </div>
                    <div class="flex flex-col items-center flex-1 h-full justify-end group cursor-pointer">
                        <div class="w-full bg-green-600 rounded-t-xl group-hover:bg-green-700 transition-colors relative"
                            style="height: 95%">
                            <div
                                class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                ‚Çπ5.8k</div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 mt-2">MAY</p>
                    </div>
                    <div class="flex flex-col items-center flex-1 h-full justify-end group cursor-pointer">
                        <div class="w-full bg-green-700 rounded-t-xl group-hover:bg-green-800 transition-colors relative"
                            style="height: 100%">
                            <div
                                class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                ‚Çπ6.2k</div>
                        </div>
                        <p class="text-[10px] font-bold text-slate-400 mt-2">JUN</p>
                    </div>
                </div>

                <!-- Analysis Table -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Lowest Price</p>
                        <p class="text-lg font-bold text-red-500">‚Çπ4,200</p>
                    </div>
                    <div class="text-center border-x border-slate-50">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Highest Price</p>
                        <p class="text-lg font-bold text-green-600">‚Çπ5,100</p>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Market Prediction</p>
                        <p class="text-lg font-bold text-blue-600">BULLISH üìà</p>
                    </div>
                </div>

                <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100 italic text-sm text-blue-800">
                    üí° <strong>Smart Advice:</strong> Large inventory build-up expected in July. It is highly
                    recommended to sell your Soybean stock before June 20th to maximize profit.
                </div>
            </div>
        </div>
    </div>

    <!-- ‚òÄÔ∏è Weather Detail Modal (NEW) -->
    <div id="weatherModal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800">7-Day Forecast</h3>
                <button onclick="closeModal('weatherModal')"
                    class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div id="weatherModalList" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Forecast Injected Here -->
            </div>
        </div>
    </div>


    <!-- üìç Location Settings Modal (NEW) -->
    <div id="locationSettingsModal"
        class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
        <div
            class="bg-white w-full max-w-2xl rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 duration-300 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800">üìç Location Settings</h3>
                <button onclick="closeModal('locationSettingsModal')"
                    class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>

            <!-- Current Location Display -->
            <div id="currentLocationDisplay"
                class="hidden mb-6 p-4 bg-gradient-to-r from-green-500 to-green-600 rounded-2xl text-white">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl">üìç</span>
                        <div>
                            <p class="font-bold text-lg" id="currentLocationCity">Mumbai, Maharashtra</p>
                            <p class="text-sm opacity-90" id="currentLocationMethod">Auto-detected</p>
                        </div>
                    </div>
                    <button onclick="clearLocation()"
                        class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-semibold transition-all">
                        Clear
                    </button>
                </div>
            </div>

            <!-- Method Selection -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="autoDetectBtn" onclick="selectLocationMethod('auto')"
                    class="p-6 border-2 border-green-500 bg-green-50 rounded-2xl flex flex-col items-center gap-2 transition-all">
                    <span class="text-4xl">üéØ</span>
                    <span class="font-semibold text-green-700">Auto-Detect</span>
                </button>
                <button id="manualEntryBtn" onclick="selectLocationMethod('manual')"
                    class="p-6 border-2 border-slate-200 bg-white rounded-2xl flex flex-col items-center gap-2 hover:border-green-500 hover:bg-green-50 transition-all">
                    <span class="text-4xl">‚úèÔ∏è</span>
                    <span class="font-semibold text-slate-700">Manual Entry</span>
                </button>
            </div>

            <!-- Auto-Detect Content -->
            <div id="autoDetectContent" class="space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-sm text-slate-700">üìç Use your device's GPS to automatically detect your location.
                    </p>
                    <p class="text-xs text-slate-500 mt-2 italic">You'll be asked to allow location access.</p>
                </div>
                <button onclick="detectLocation()" id="detectBtn"
                    class="w-full py-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition-all">
                    üìç Detect My Location
                </button>
            </div>

            <!-- Manual Entry Content -->
            <div id="manualEntryContent" class="hidden space-y-4">
                <div class="bg-slate-50 p-4 rounded-xl">
                    <p class="text-sm text-slate-700">‚úèÔ∏è Enter your city name manually.</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Search Location (All India)</label>
                    <input type="text" id="manualCity" placeholder="Enter Village, Taluk, District or City name..."
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-green-500 focus:outline-none transition-all">
                    <p class="text-xs text-slate-400 mt-2 italic">Example: "Thanjavur", "Melur, Madurai", "Kovipatti"
                    </p>
                </div>

                <button onclick="saveManualLocation()" id="saveLocationBtn"
                    class="w-full py-4 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition-all">
                    üíæ Search & Save Location
                </button>

                <div class="bg-yellow-50 p-4 rounded-xl border-l-4 border-yellow-400">
                    <p class="text-xs text-yellow-800">
                        <strong>Supported Cities:</strong> Mumbai, Delhi, Bangalore, Chennai, Kolkata, Hyderabad, Pune,
                        Ahmedabad, Nashik, and 20+ more major cities.
                    </p>
                </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="locationMessage" class="hidden mt-4 p-4 rounded-xl"></div>
        </div>
    </div>

    <!-- ‚ú® Plan My Crop Modal -->
    <div id="planModal"
        class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/70 backdrop-blur-md overflow-y-auto">
        <div class="bg-slate-50 w-full max-w-4xl rounded-[3rem] p-6 md:p-10 shadow-2xl my-8">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h3 class="text-3xl font-bold text-slate-800">Smart Crop Recommendations</h3>
                    <p class="text-slate-500 font-medium">Ranked by ROI √ó AI Confidence Score</p>
                </div>
                <button onclick="closeModal('planModal')"
                    class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>

            <div id="recommendationGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Data will be injected here -->
            </div>
        </div>
    </div>

    <!-- üóìÔ∏è Week-by-Week Timeline Modal -->
    <div id="timelineModal"
        class="hidden fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md overflow-y-auto">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-8 md:p-12 shadow-2xl my-8">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <span
                        class="text-xs font-bold text-green-600 uppercase tracking-widest bg-green-50 px-3 py-1 rounded-full">Growth
                        Plan</span>
                    <h3 id="timelineCropName" class="text-3xl font-bold text-slate-800 mt-2">Crop Mastery</h3>
                </div>
                <button onclick="closeModal('timelineModal')"
                    class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            <div id="timelineSteps"
                class="space-y-8 relative before:absolute before:left-4 before:top-2 before:bottom-2 before:w-0.5 before:bg-slate-100">
                <!-- Steps injected here -->
            </div>
            <div class="mt-12 flex gap-4">
                <button onclick="confirmPlan()"
                    class="flex-1 py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-2xl shadow-lg transition-all">Yes,
                    I'll grow this! üåæ</button>
                <button onclick="closeModal('timelineModal')"
                    class="flex-1 py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl">Skip</button>
            </div>
        </div>
    </div>
    <div id="diseaseModal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 duration-300 my-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800">Disease Detection üè•</h3>
                <button onclick="closeModal('diseaseModal')"
                    class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <div id="doctorUploadArea" class="space-y-6">
                <!-- Initial Options -->
                <div id="initialUploadState" class="grid grid-cols-2 gap-4">
                    <button onclick="document.getElementById('cameraInput').click()"
                        class="p-6 bg-green-50 rounded-3xl border-2 border-dashed border-green-200 hover:bg-green-100 transition-all text-center group">
                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üì∏</div>
                        <p class="text-xs font-bold text-green-700">Take Photo</p>
                    </button>
                    <button onclick="document.getElementById('galleryInput').click()"
                        class="p-6 bg-blue-50 rounded-3xl border-2 border-dashed border-blue-200 hover:bg-blue-100 transition-all text-center group">
                        <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üñºÔ∏è</div>
                        <p class="text-xs font-bold text-blue-700">From Gallery</p>
                    </button>
                </div>
                <!-- Camera Input (Direct) -->
                <input type="file" id="cameraInput" class="hidden" accept="image/*" capture="environment"
                    onchange="handleDoctorUpload(event)">
                <!-- Gallery Input (Standard) -->
                <input type="file" id="galleryInput" class="hidden" accept="image/*"
                    onchange="handleDoctorUpload(event)">

                <!-- Live Scanner Preview (Shown after selection) -->
                <div id="liveScannerPreview" class="hidden space-y-4">
                    <div class="relative rounded-3xl overflow-hidden border-4 border-green-100 shadow-xl group">
                        <img id="scanPreviewImg" src="" class="w-full h-56 object-cover" alt="Scan Preview">
                        <!-- Simulated Real-time Detection (Boxes Removed) -->
                        <div class="absolute inset-0 pointer-events-none">
                            <!-- Scanning Line -->
                            <div
                                class="absolute top-0 left-0 w-full h-1 bg-green-400/50 shadow-[0_0_15px_rgba(74,222,128,0.5)] animate-[scan_2s_linear_infinite]">
                            </div>
                        </div>
                        <div
                            class="absolute top-3 left-3 bg-red-600 text-[8px] text-white px-2 py-1 rounded-full font-bold uppercase tracking-tighter animate-pulse">
                            Live Analysis...</div>
                    </div>

                    <!-- Quality Tips -->
                    <div id="qualityTips" class="p-4 bg-orange-50 border border-orange-100 rounded-2xl">
                        <p class="text-[10px] font-bold text-orange-600 uppercase mb-2 text-center">AI Vision Locked on
                            Symptoms üéØ</p>
                        <button id="autoScanBtn" disabled
                            class="w-full py-4 bg-slate-400 text-white font-bold rounded-2xl shadow-lg transition-all cursor-not-allowed">AI
                            Analyzing
                            Symptoms...</button>
                    </div>
                </div>
            </div>

            <style>
                @keyframes scan {
                    0% {
                        top: 0%;
                    }

                    100% {
                        top: 100%;
                    }
                }
            </style>

            <!-- Loading State -->
            <div id="doctorLoading" class="hidden py-20 text-center space-y-4">
                <div class="text-5xl animate-bounce">üîç</div>
                <p class="text-slate-500 font-bold">AI Analyzing Symptoms...</p>
            </div>

            <!-- Full Clinical Result -->
            <div id="doctorResult" class="hidden space-y-6">
                <!-- Sticky Quick Actions -->
                <div class="sticky-quick-bar flex gap-2 overflow-x-auto no-scrollbar">
                    <button onclick="playVoiceReport()"
                        class="flex-shrink-0 px-4 py-2 bg-blue-600 text-white rounded-xl text-[10px] font-bold shadow-lg shadow-blue-200">üîä
                        Listen</button>
                    <button onclick="alert('Connecting to Expert...')"
                        class="flex-shrink-0 px-4 py-2 bg-slate-900 text-white rounded-xl text-[10px] font-bold">üìû
                        Expert</button>
                    <button onclick="document.getElementById('shopList').scrollIntoView({behavior:'smooth'})"
                        class="flex-shrink-0 px-4 py-2 bg-green-600 text-white rounded-xl text-[10px] font-bold">üõí Buy
                        Now</button>
                    <button onclick="shareDiagnosis()"
                        class="flex-shrink-0 px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-xl text-[10px] font-bold">üì§
                        Share</button>
                </div>

                <!-- Diagnostic Image View -->
                <div id="diagImageContainer"
                    class="relative rounded-3xl overflow-hidden border-4 border-slate-100 shadow-xl group bg-slate-50">
                    <div class="relative w-full">
                        <img id="doctorPreviewImg" src="" class="w-full h-auto block" alt="Scanned Leaf">
                        <div id="aiVisionOverlay" class="absolute inset-0 pointer-events-none"></div>
                    </div>
                    <div class="absolute inset-0 border-2 border-green-400/50 animate-pulse pointer-events-none"></div>
                    <div
                        class="absolute top-4 left-4 bg-green-600/90 text-[8px] text-white px-2 py-1 rounded-full font-bold uppercase tracking-widest">
                        AI VISION ACTIVE
                    </div>
                </div>

                <!-- Primary Diagnosis -->
                <div class="p-6 bg-red-50 rounded-3xl border border-red-100">
                    <div class="flex justify-between items-start mb-2">
                        <h4 id="diagName" class="text-xl font-bold text-red-800">Bacterial Blight</h4>
                        <span id="diagConf"
                            class="text-xs font-bold px-2 py-1 bg-white text-red-600 rounded-lg shadow-sm">94%
                            Conf.</span>
                    </div>
                    <div class="flex items-center gap-2 mb-4">
                        <span id="diagSev"
                            class="text-[10px] font-bold text-red-600 uppercase tracking-widest px-2 py-0.5 bg-red-100 rounded-full">Severity:
                            Moderate</span>
                        <span id="diagReason"
                            class="text-[10px] font-bold text-orange-600 uppercase tracking-widest px-2 py-0.5 bg-orange-100 rounded-full">Reason:
                            Humidity</span>
                    </div>
                    <p id="diagCause" class="text-xs text-slate-700 leading-relaxed mb-4"></p>

                    <!-- Multi-Issue Detection -->
                    <div id="additionalIssues" class="hidden mt-4 pt-4 border-t border-red-100 space-y-2">
                        <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest italic">üîç Also Detected
                        </p>
                        <div id="additionalIssuesList" class="space-y-1"></div>
                    </div>
                </div>

                <!-- Smart Advisory (LLM Generated) -->
                <div class="bg-blue-600 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">ü§ñ</div>
                    <p class="text-[10px] font-bold text-blue-200 uppercase tracking-widest mb-2">üß† AI Smart Advisory
                    </p>
                    <p id="smartAdvisoryText" class="text-sm font-medium leading-relaxed">
                        Initializing advanced analysis...
                    </p>
                </div>

                <!-- Visual Damage Assessment -->
                <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm space-y-4">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">üìä Crop Damage
                        Assessment</p>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] font-bold text-slate-500">
                            <span>Affected: <span id="diagAffectedText" class="text-red-500">30%</span></span>
                            <span>Healthy: <span id="diagHealthyText" class="text-green-500">70%</span></span>
                        </div>
                        <div class="damage-bar">
                            <div id="diagAffectedBar" class="affected" style="width: 30%;">30%</div>
                            <div id="diagHealthyBar" class="healthy flex-1"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 pt-2">
                        <div class="bg-red-50 p-3 rounded-2xl border border-red-100">
                            <p class="text-[9px] text-red-600 uppercase font-bold mb-1">‚è∞ Urgency</p>
                            <p id="diagUrgency" class="text-[10px] font-bold text-red-700 leading-tight">Treat within
                                48h</p>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-2xl border border-orange-100">
                            <p class="text-[9px] text-orange-600 uppercase font-bold mb-1">üìà Spread Risk</p>
                            <p id="diagSpread" class="text-[10px] font-bold text-orange-700">Moderate High</p>
                        </div>
                    </div>
                </div>

                <!-- Recommended Action Plan (ML/RL Output) -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-50 p-4 rounded-3xl border border-slate-200">
                        <p class="text-[9px] text-slate-400 uppercase font-bold mb-2">üíß Irrigation</p>
                        <p id="actionIrrigation" class="text-xs font-bold text-slate-700">Normal schedule</p>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-3xl border border-slate-200">
                        <p class="text-[9px] text-slate-400 uppercase font-bold mb-2">üöú Harvest Impact</p>
                        <p id="actionHarvest" class="text-xs font-bold text-slate-700">On Track</p>
                    </div>
                </div>

                <!-- Premium Economic ROI Card -->
                <div class="econ-card-premium rounded-3xl p-6 text-white overflow-hidden relative">
                    <div class="absolute -right-8 -top-8 w-32 h-32 bg-white/5 rounded-full"></div>
                    <div class="relative z-10 space-y-4">
                        <div class="flex justify-between items-center">
                            <h5 class="text-sm font-bold text-blue-200 italic">üí∞ Save Your Crop & Money</h5>
                            <span id="econRoi"
                                class="bg-green-500 text-white text-[8px] font-black px-2 py-1 rounded-full uppercase tracking-tighter shadow-lg shadow-green-900/40">18x
                                ROI</span>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <p class="text-[9px] text-slate-400 uppercase font-bold">If NO Treatment</p>
                                <p id="econLoss" class="text-2xl font-black text-red-400">‚Çπ12,500 <span
                                        class="text-[10px] block font-medium">LOSE</span></p>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[9px] text-slate-400 uppercase font-bold">If Treat NOW</p>
                                <p id="econCost" class="text-2xl font-black text-green-400">‚Çπ700 <span
                                        class="text-[10px] block font-medium">SPEND</span></p>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-white/10">
                            <p id="econSmartNote" class="text-center text-[11px] font-bold text-green-300">üéØ Smart
                                Decision: Save ‚Çπ11,800 today!</p>
                        </div>
                    </div>
                </div>

                <!-- Weather Timing -->
                <div class="bg-indigo-50 rounded-3xl p-6 border border-indigo-100 space-y-3">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">üå§Ô∏è</span>
                        <div>
                            <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest italic">Best
                                Application Time</p>
                            <p id="weatherTime" class="text-sm font-bold text-indigo-700">Today 5:00 PM - 7:00 PM</p>
                        </div>
                    </div>
                    <div class="bg-white/50 p-3 rounded-xl border border-indigo-100">
                        <p id="weatherForecast" class="text-[11px] text-indigo-600 font-bold mb-1">Sunny Today | Rain
                            Tomorrow</p>
                        <p id="weatherReason" class="text-[10px] text-slate-500 italic leading-tight">Apply before rain
                            washes the medicine.</p>
                    </div>
                </div>

                <!-- Treatment Plan -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center px-2">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">üíä Treatment Plan</p>
                        <button onclick="toggleCompare()"
                            class="text-[11px] font-bold text-blue-600 flex items-center gap-1">‚öñÔ∏è Compare <span
                                class="text-[8px]">‚ñº</span></button>
                    </div>

                    <div id="compareView"
                        class="hidden bg-slate-50 rounded-3xl overflow-hidden border border-slate-200 animate-in fade-in duration-300">
                        <table class="w-full text-[10px]">
                            <thead>
                                <tr class="bg-slate-100 text-slate-600">
                                    <th class="p-2 text-left">Feature</th>
                                    <th class="p-2 text-center text-green-600">Organic</th>
                                    <th class="p-2 text-center text-blue-600">Chemical</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr>
                                    <td class="p-2 font-bold">Effectiveness</td>
                                    <td id="compEffOrg" class="p-2 text-center font-bold">85%</td>
                                    <td id="compEffChem" class="p-2 text-center font-bold">95%</td>
                                </tr>
                                <tr>
                                    <td class="p-2 font-bold">Cost</td>
                                    <td id="compCostOrg" class="p-2 text-center">‚Çπ500</td>
                                    <td id="compCostChem" class="p-2 text-center">‚Çπ800</td>
                                </tr>
                                <tr>
                                    <td class="p-2 font-bold">Soil Health</td>
                                    <td class="p-2 text-center text-green-500 font-bold">Excellent</td>
                                    <td class="p-2 text-center text-orange-400">Moderate</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-2xl">
                        <button onclick="setTreatmentTab('organic')" id="tab-organic"
                            class="py-2 px-4 rounded-xl font-bold text-sm transition-all bg-white shadow-sm text-green-700">Organic</button>
                        <button onclick="setTreatmentTab('chemical')" id="tab-chemical"
                            class="py-2 px-4 rounded-xl font-bold text-sm transition-all text-slate-500">Chemical</button>
                    </div>
                    <div id="treatmentContent"
                        class="p-4 border border-slate-100 rounded-2xl bg-white shadow-sm border-t-4 border-t-green-500">
                        <!-- Content Injected -->
                    </div>

                </div>

                <!-- Recovery Checklist -->
                <div class="bg-emerald-50 rounded-3xl p-6 border border-emerald-100 space-y-4">
                    <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest italic">üìà Recovery
                        Checklist</p>
                    <div id="recoveryTimeline" class="flex justify-between items-start gap-2"></div>
                </div>

                <!-- Prevention Checklist -->
                <div class="bg-amber-50 rounded-3xl p-6 border border-amber-100 space-y-4">
                    <p class="text-[10px] font-bold text-amber-600 uppercase tracking-widest italic">üõ°Ô∏è Prevention
                        Checklist (Next Season)</p>
                    <div id="preventionTips" class="space-y-2"></div>
                    <button onclick="alert('Reminders set for next season planning!')"
                        class="w-full py-3 bg-amber-600 text-white rounded-xl text-xs font-bold hover:bg-amber-700 shadow-lg">üíæ
                        Save & Set Reminders</button>
                </div>



                <!-- Suppliers -->
                <div class="space-y-3">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-2">üè™ Buy Recommended
                        Medicines Nearby</p>
                    <div id="shopList" class="space-y-2">
                        <!-- Shops Injected -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-6 sticky bottom-0 bg-white/80 backdrop-blur pb-2">
                    <button onclick="followTreatment()"
                        class="flex-1 py-4 bg-green-600 text-white font-bold rounded-2xl shadow-lg ring-4 ring-green-100">Save
                        Discovery</button>
                    <button onclick="closeModal('diseaseModal')"
                        class="px-8 py-4 bg-slate-100 text-slate-600 font-bold rounded-2xl">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- üí∞ Market News Modal (NEW) -->
    <div id="marketModal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div
            class="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 duration-300 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-slate-800">Market News</h3>
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mt-1">Live Mandi Prices ‚Ä¢
                        Nashik</p>
                </div>
                <button onclick="closeModal('marketModal')"
                    class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <div class="space-y-4">
                <!-- Price List -->
                <div id="mandiPricesGrid" class="grid grid-cols-2 gap-3">
                    <div class="animate-pulse col-span-2 text-center text-xs text-slate-400 py-10">
                        üíπ Syncing with Agmarknet Live Prices...
                    </div>
                </div>

                <!-- News Section -->
                <div class="space-y-4 pt-4">
                    <h4 class="font-bold text-slate-800 border-b border-slate-100 pb-2">Latest Headlines</h4>
                    <div id="marketNewsList" class="space-y-4">
                        <div class="animate-pulse text-xs text-slate-400 font-bold">üì° Fetching latest agricultural
                            updates...</div>
                    </div>
                </div>
            </div>

            <button onclick="showModal('trendsModal')"
                class="w-full mt-8 py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg shadow-blue-200">
                View All Price Trends
            </button>
        </div>
    </div>

    <!-- üìä Crop Details Modal (NEW) -->
    <div id="cropModal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div
            class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom-8 duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalCropName" class="text-2xl font-bold text-slate-800">Crop Analysis</h3>
                <button onclick="closeModal('cropModal')"
                    class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div class="space-y-6">
                <div class="flex justify-between p-4 bg-slate-50 rounded-2xl">
                    <span class="text-slate-500 font-medium">Optimal Rainfall</span>
                    <span id="modalRainfall" class="font-bold text-slate-800 text-right">800-1200 mm</span>
                </div>
                <div class="flex justify-between p-4 bg-slate-50 rounded-2xl">
                    <span class="text-slate-500 font-medium">Soil PH Level</span>
                    <span class="font-bold text-slate-800 text-right">6.5 - 7.5</span>
                </div>
                <div class="flex justify-between p-4 bg-slate-50 rounded-2xl">
                    <span class="text-slate-500 font-medium">Market Demand</span>
                    <span class="font-bold text-green-600 text-right flex items-center gap-1">High üìà</span>
                </div>
                <p class="text-slate-500 text-sm leading-relaxed px-2">
                    Our AI models predict a high yield for <span id="modalCropSpan"
                        class="font-bold text-slate-800">this crop</span> based on your current soil profile and the
                    upcoming monsoon forecast.
                </p>
                <button class="w-full py-4 bg-green-600 text-white font-bold rounded-2xl" onclick="downloadGuide()">
                    Download Sowing Guide
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Mobile Nav -->
    <div class="fixed bottom-0 left-0 right-0 glass-nav border-t px-6 py-4 md:hidden flex justify-between">
        <button onclick="showSection('dashboard')" class="text-green-600">üè†</button>
        <button class="text-slate-400">üìä</button>
        <div class="w-12 h-12 bg-green-600 rounded-full -mt-10 border-4 border-white flex items-center justify-center text-white shadow-lg cursor-pointer"
            onclick="showModal('diseaseModal')">‚ûï</div>
        <button class="text-slate-400">üí¨</button>
        <button onclick="showSection('profile')" class="text-slate-400">üë§</button>
    </div>

    <script>
        const farmer = JSON.parse(localStorage.getItem('farmer') || '{}');
        const token = localStorage.getItem('token');
        const BACKEND_URL = getApiUrl();
        // ML_URL is now defined globally in <head>

        if (!token) window.location.href = 'index.html';

        // Load Header Details
        const fullName = `${farmer.firstName || ''} ${farmer.lastName || ''}`.trim() || 'Farmer';
        document.getElementById('welcomeName').textContent = farmer.firstName || 'Farmer';
        document.getElementById('profileName').textContent = fullName;
        document.getElementById('profilePhone').textContent = `+91 ${farmer.phone || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}`;

        const initial = (farmer.firstName || 'K').charAt(0).toUpperCase();
        document.getElementById('userInitial').textContent = initial;
        document.getElementById('profileBadge').textContent = initial;

        // Load Online Data
        refreshOnlineData();

        async function refreshOnlineData() {
            try {
                // 1. Fetch Weather
                const weatherRes = await fetch(`${BACKEND_URL}/api/online/weather`);
                const weather = await weatherRes.json();
                if (weather.success) {
                    document.getElementById('weatherCity').textContent = `Live Weather - ${weather.city}`;
                    document.getElementById('weatherTemp').textContent = `${weather.temp}¬∞C`;
                    document.getElementById('weatherDesc').textContent = weather.description;
                    document.getElementById('weatherTips').textContent = weather.forecast || "Perfect conditions for farming today.";
                }

                // 2. Fetch Daily News
                const newsRes = await fetch(`${BACKEND_URL}/api/online/news`);
                const news = await newsRes.json();
                if (news.success) {
                    const newsList = document.getElementById('marketNewsList');
                    newsList.innerHTML = news.news.map(item => `
                        <div onclick="window.open('${item.url}', '_blank')" class="flex gap-4 p-3 bg-slate-50 rounded-2xl hover:bg-slate-100 transition-all cursor-pointer">
                            <div class="w-12 h-12 bg-cover bg-center rounded-xl shadow-sm shrink-0" style="background-image: url('${item.img}')"></div>
                            <div>
                                <h4 class="text-xs font-bold text-slate-800 line-clamp-2">${item.title}</h4>
                                <p class="text-[10px] text-slate-400 font-bold uppercase mt-1">${item.source}</p>
                            </div>
                        </div>
                    `).join('');
                }

                // 3. Fetch Mandi Prices
                const priceRes = await fetch(`${BACKEND_URL}/api/online/prices`);
                const priceData = await priceRes.json();
                if (priceData.success) {
                    const priceGrid = document.getElementById('mandiPricesGrid');
                    priceGrid.innerHTML = priceData.prices.map(p => `
                        <div class="p-4 bg-white border border-slate-100 rounded-2xl shadow-sm">
                            <p class="text-[10px] font-bold ${p.trend === 'up' ? 'text-green-600' : 'text-red-600'} uppercase">${p.crop}</p>
                            <p class="text-xl font-bold text-slate-800">‚Çπ${p.price.toLocaleString()} <span class="text-xs">${p.trend === 'up' ? '‚ñ≤' : '‚ñº'}</span></p>
                            <p class="text-[10px] text-slate-400">${p.unit}</p>
                        </div>
                    `).join('');
                }

                // 4. Fetch Warehouses
                const whRes = await fetch(`${BACKEND_URL}/api/online/warehouses`);
                const whData = await whRes.json();
                if (whData.success) {
                    const whList = document.getElementById('warehouseList');
                    if (whList) {
                        whList.innerHTML = whData.warehouses.map(w => `
                            <div class="p-4 bg-slate-50 border border-slate-100 rounded-2xl hover:border-green-300 transition-all">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-bold text-slate-800">${w.name || w.warehouse_name}</h4>
                                        <p class="text-xs text-slate-500">üìç ${w.location}</p>
                                    </div>
                                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-[10px] font-bold">${w.type || 'Storage'}</span>
                                </div>
                                <div class="mt-4 flex justify-between items-end">
                                    <div>
                                        <p class="text-[10px] text-slate-400 uppercase font-bold">Space Available</p>
                                        <p class="text-sm font-bold text-slate-700">${w.availableSpace || w.available_space} / ${w.capacity}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[10px] text-green-600 font-bold">‚Çπ${w.pricePerQuintal || w.price_per_quintal}/qnt</p>
                                        <button onclick="window.open('tel:${w.contact || w.contact_phone}')" class="mt-2 text-[10px] bg-green-600 text-white px-4 py-2 rounded-lg font-bold">Call Manager</button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                }

            } catch (err) {
                console.error("Online Sync Error:", err);
            }
        }

        // --- HELPERS ---
        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function showCropDetail(name, rain) {
            document.getElementById('modalCropName').textContent = name;
            document.getElementById('modalCropSpan').textContent = name;
            document.getElementById('modalRainfall').textContent = rain;
            showModal('cropModal');
        }

        // --- CROP DOCTOR LOGIC ---
        let doctorData = null;
        let selectedFile = null;
        function handleDoctorUpload(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('scanPreviewImg').src = e.target.result;
                    document.getElementById('doctorPreviewImg').src = e.target.result;
                }
                reader.readAsDataURL(file);

                document.getElementById('initialUploadState').classList.add('hidden');
                document.getElementById('liveScannerPreview').classList.remove('hidden');

                // Auto-trigger scan after 0.8 seconds of "Scanning" animation
                setTimeout(() => {
                    simulateDoctorScan();
                }, 800);
            }
        }

        async function simulateDoctorScan() {
            if (!selectedFile) return;
            try {
                // Auto-detect or use user profile for Multi-Modal Inputs
                const soilType = "Black"; // In production, get from user Profile
                const weatherCondition = document.getElementById('weatherDesc').textContent || "Sunny";

                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('soil_type', soilType);
                formData.append('weather', weatherCondition);

                const res = await fetch(`${ML_URL}/analyze-disease`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors',
                    cache: 'no-cache'
                });

                if (!res.ok) throw new Error("Server Error");
                doctorData = await res.json();

                document.getElementById('doctorUploadArea').classList.add('hidden');
                document.getElementById('doctorLoading').classList.add('hidden');
                document.getElementById('doctorResult').classList.remove('hidden');

                // Basic Info
                document.getElementById('diagName').textContent = doctorData.disease;
                document.getElementById('diagConf').textContent = doctorData.confidence + " Conf.";
                document.getElementById('diagSev').textContent = doctorData.severity;
                document.getElementById('diagReason').textContent = doctorData.reason;
                document.getElementById('diagCause').textContent = doctorData.cause;

                // --- POPULATE MULTI-MODAL ADVISORY ---
                if (doctorData.smart_advisory) {
                    const typedText = doctorData.smart_advisory;
                    document.getElementById('smartAdvisoryText').textContent = typedText;
                }

                if (doctorData.action_plan) {
                    document.getElementById('actionIrrigation').textContent = doctorData.action_plan.irrigation;
                    document.getElementById('actionHarvest').textContent = doctorData.action_plan.harvest_impact;
                }
                // -------------------------------------

                // Visual Damage Assessment
                const affected = doctorData.damage_assessment.affected_area;
                const healthy = (100 - parseInt(affected)) + "%";
                document.getElementById('diagAffectedText').textContent = affected;
                document.getElementById('diagHealthyText').textContent = healthy;
                document.getElementById('diagAffectedBar').style.width = affected;
                document.getElementById('diagAffectedBar').textContent = affected;
                document.getElementById('diagSpread').textContent = doctorData.damage_assessment.spread_rate;
                document.getElementById('diagUrgency').textContent = doctorData.damage_assessment.urgency;

                // Economics
                document.getElementById('econCost').innerHTML = `${doctorData.economics.treatment_cost} <span class="text-[10px] block font-medium">SPEND</span>`;
                document.getElementById('econLoss').innerHTML = `${doctorData.economics.potential_loss_value} <span class="text-[10px] block font-medium">LOSE</span>`;
                document.getElementById('econRoi').textContent = doctorData.economics.roi + " ROI";

                // Smart Note Calculation
                const lossVal = parseInt(doctorData.economics.potential_loss_value.replace(/\D/g, ''));
                const costVal = parseInt(doctorData.economics.treatment_cost.replace(/\D/g, ''));
                document.getElementById('econSmartNote').textContent = `üéØ Smart Decision: Save ‚Çπ${(lossVal - costVal).toLocaleString()} today!`;

                // Weather Timing
                document.getElementById('weatherTime').textContent = doctorData.weather_timing.best_time;
                document.getElementById('weatherForecast').textContent = doctorData.weather_timing.forecast;
                document.getElementById('weatherReason').textContent = doctorData.weather_timing.reason;

                // Additional Issues
                const issueArea = document.getElementById('additionalIssues');
                const issueList = document.getElementById('additionalIssuesList');
                if (doctorData.additional_issues && doctorData.additional_issues.length > 0) {
                    issueArea.classList.remove('hidden');
                    issueList.innerHTML = doctorData.additional_issues.map(i => `
                        <div class="flex justify-between items-center text-[10px] bg-white/40 p-2 rounded-lg">
                            <span class="font-bold text-slate-700">${i.name} (${i.severity})</span>
                            <span class="text-red-500 font-bold">${i.confidence}</span>
                        </div>
                    `).join('');
                } else {
                    issueArea.classList.add('hidden');
                }

                // Recovery Checklist items
                const recoveryTimeline = document.getElementById('recoveryTimeline');
                recoveryTimeline.innerHTML = doctorData.recovery_tracking.timeline.map(t => `
                    <div class="flex-1 text-center group">
                        <div class="w-10 h-10 mx-auto rounded-full bg-white shadow-sm flex items-center justify-center text-lg mb-1 group-hover:scale-110 transition-transform">${t.icon}</div>
                        <p class="text-[9px] font-bold text-slate-500">Day ${t.day}</p>
                        <p class="text-[8px] text-slate-400 leading-tight">${t.status}</p>
                    </div>
                `).join('');

                // Prevention Checklist
                const preventionArea = document.getElementById('preventionTips');
                preventionArea.innerHTML = doctorData.prevention.next_season.map((tip, idx) => `
                    <label class="flex items-start gap-3 bg-white/60 p-3 rounded-xl border border-amber-100/50 cursor-pointer hover:bg-white transition-colors">
                        <input type="checkbox" class="mt-1 accent-amber-600">
                        <p class="text-[10px] text-amber-900 font-medium">${tip}</p>
                    </label>
                `).join('');



                // Comparison Table data
                document.getElementById('compEffOrg').textContent = doctorData.treatments.organic.effectiveness;
                document.getElementById('compEffChem').textContent = doctorData.treatments.chemical.effectiveness;
                document.getElementById('compCostOrg').textContent = doctorData.treatments.organic.price;
                document.getElementById('compCostChem').textContent = doctorData.treatments.chemical.price;

                setTreatmentTab('organic');

                const shopList = document.getElementById('shopList');
                shopList.innerHTML = (doctorData.shops || []).map(s => `
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 group">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm font-bold text-slate-800">${s.name}</p>
                                <p class="text-xs text-green-600 font-bold">${s.dist} ‚Ä¢ In Stock</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="alert('Calling ${s.name}...')" class="p-2 bg-white rounded-lg shadow-sm text-green-600 hover:bg-green-600 hover:text-white transition-all">üìû</button>
                                <button onclick="window.open('https://www.google.com/maps/search/' + encodeURIComponent(s.name + ' ' + s.location))" class="p-2 bg-white rounded-lg shadow-sm text-blue-600 hover:bg-blue-600 hover:text-white transition-all">üìç</button>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-500 leading-tight"><span class="font-bold">üìç Location:</span> ${s.location}</p>
                    </div>
                `).join('');
            } catch (err) {
                console.error("Diagnosis Error:", err);
                // Simple error handling
            }
        }

        function toggleCompare() {
            const view = document.getElementById('compareView');
            view.classList.toggle('hidden');
        }

        function playVoiceReport() {
            if (!doctorData) return;
            const report = `Diagnosis: ${doctorData.disease}. Severity is ${doctorData.severity}. 
                Damage is ${doctorData.damage_assessment.affected_area}. 
                Smart Recommendation: Treat now to save your investment. 
                Best time to spray is ${doctorData.weather_timing.best_time}.`;
            speak(report);
        }

        function shareDiagnosis() {
            if (!doctorData) return;
            const text = `üåæ *KrishiMitra AI Report*\n*Disease*: ${doctorData.disease}\n*Affected*: ${doctorData.damage_assessment.affected_area}\n*ROI*: ${doctorData.economics.roi}\n*Best Time*: ${doctorData.weather_timing.best_time}\n\nDownload KrishiMitra for full report!`;
            const url = `whatsapp://send?text=${encodeURIComponent(text)}`;
            window.open(url);
        }

        function setTreatmentTab(type) {
            if (!doctorData || !doctorData.treatments) return;
            const orgBtn = document.getElementById('tab-organic');
            const chemBtn = document.getElementById('tab-chemical');
            const content = document.getElementById('treatmentContent');
            const treatment = type === 'organic' ? doctorData.treatments.organic : doctorData.treatments.chemical;
            if (!treatment) return;

            // Highlight active tab
            if (type === 'organic') {
                orgBtn.className = "py-2 px-4 rounded-xl font-bold text-sm transition-all bg-white shadow-sm text-green-700";
                chemBtn.className = "py-2 px-4 rounded-xl font-bold text-sm transition-all text-slate-500";
            } else {
                chemBtn.className = "py-2 px-4 rounded-xl font-bold text-sm transition-all bg-white shadow-sm text-blue-700";
                orgBtn.className = "py-2 px-4 rounded-xl font-bold text-sm transition-all text-slate-500";
            }

            const colorClass = type === 'organic' ? 'green' : 'blue';
            const stepsHtml = (treatment.steps || []).map(step => `
                <div class="flex gap-2 items-start">
                    <div class="w-1.5 h-1.5 bg-${colorClass}-500 rounded-full mt-1.5 flex-shrink-0"></div>
                    <p class="text-[11px] text-slate-600 leading-tight">${step}</p>
                </div>
            `).join('');

            const benefitsHtml = (treatment.benefits || []).map(b => `
                <span class="text-[9px] font-bold text-${colorClass}-600 bg-${colorClass}-50 px-2 py-0.5 rounded-full border border-${colorClass}-100">${b}</span>
            `).join(' ');

            content.innerHTML = `
                <div class="space-y-3 animate-in fade-in duration-300">
                    <div class="flex justify-between items-start">
                        <div>
                            <h5 class="font-bold text-${colorClass}-700 text-sm">${treatment.name}</h5>
                            <div class="flex gap-1 mt-1 flex-wrap">${benefitsHtml}</div>
                        </div>
                        <span class="text-[10px] font-bold text-${colorClass}-600 bg-${colorClass}-50 px-2 py-0.5 rounded-lg border border-${colorClass}-100 shadow-sm">${treatment.price}</span>
                    </div>
                    
                    <div class="bg-${colorClass}-50/30 p-2 rounded-xl border border-${colorClass}-100/50">
                        <p class="text-[9px] font-bold text-${colorClass}-600 uppercase mb-1">AI Effectiveness Rating</p>
                        <div class="flex items-center gap-2">
                            <div class="flex-1 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                <div class="h-full bg-${colorClass}-500" style="width: ${treatment.effectiveness}"></div>
                            </div>
                            <span class="text-[10px] font-bold text-slate-700">${treatment.effectiveness}</span>
                        </div>
                    </div>

                    <p class="text-[11px] text-slate-500 leading-relaxed italic">${treatment.usage || ''}</p>
                    <div class="space-y-2 pt-2 border-t border-slate-50">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic flex items-center gap-1">
                            <span>üìù Application Guide:</span>
                        </p>
                        <div class="space-y-2">
                            ${stepsHtml || '<p class="text-[10px] text-slate-400 italic">No specific steps provided.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function followTreatment() {
            alert("Following treatment! üíä We've set a reminder to check your crop again in 7 days.");
            closeModal('diseaseModal');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            if (id === 'diseaseModal') {
                document.getElementById('initialUploadState').classList.remove('hidden');
                document.getElementById('liveScannerPreview').classList.add('hidden');
                document.getElementById('doctorResult').classList.add('hidden');
                document.getElementById('doctorLoading').classList.add('hidden');
            }
        }


        function downloadGuide() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "‚åõ Generating PDF...";
            btn.disabled = true;
            setTimeout(() => {
                btn.textContent = "‚úÖ Guide Downloaded!";
                btn.classList.add('bg-green-700');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.classList.remove('bg-green-700');
                }, 2000);
            }, 100);
        }

        function toggleDetailedAnalysis() {
            showModal('trendsModal');
        }

        async function planMyCrop() {
            showModal('planModal');
            const grid = document.getElementById('recommendationGrid');
            grid.innerHTML = '<div class="col-span-full py-10 text-center animate-pulse">‚ú® AI is calculating your 7-day forecast & ROI...</div>';

            try {
                // Flowchart Step 1-4: Fetch data & ML Call
                const response = await fetch(`${ML_URL}/recommend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        soil_type: "Black",
                        season: "Kharif",
                        rainfall: 850,
                        temperature: 28,
                        land_size: 2
                    })
                });
                const data = await response.json();

                if (data.success) {
                    grid.innerHTML = data.recommendations.map((crop, i) => `
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm hover:shadow-xl transition-all group">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-xs font-bold px-2 py-1 bg-green-50 text-green-600 rounded-lg">#${i + 1} Match</span>
                                <span class="text-2xl">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'üå±'}</span>
                            </div>
                            <h4 class="text-xl font-bold text-slate-800">${crop.name}</h4>
                            <p class="text-xs font-bold text-green-500 mb-4">Confidence: ${crop.confidence}</p>
                            
                            <div class="grid grid-cols-2 gap-2 mb-6 text-sm">
                                <div class="bg-slate-50 p-2 rounded-xl"><p class="text-[10px] text-slate-400">Income</p><p class="font-bold">${crop.income}</p></div>
                                <div class="bg-slate-50 p-2 rounded-xl"><p class="text-[10px] text-slate-400">Risk</p><p class="font-bold">${crop.risk}</p></div>
                            </div>
                            
                            <button onclick='showTimeline(${JSON.stringify(crop)})' class="w-full py-3 bg-slate-900 group-hover:bg-green-600 text-white text-sm font-bold rounded-xl transition-colors">
                                View Details
                            </button>
                        </div>
                    `).join('');
                } else { throw new Error(); }
            } catch (err) {
                console.error("Planning Error:", err);
                grid.innerHTML = `
                    <div class="col-span-full py-10 text-center space-y-4">
                        <p class="text-red-500 font-bold">‚ö†Ô∏è Local AI Node is restarting...</p>
                        <p class="text-xs text-slate-400">The system is optimizing for your region. Please try again in a few moments.</p>
                        <button onclick="planMyCrop()" class="px-6 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold rounded-xl transition-all">Retry Analysis</button>
                    </div>
                `;
            }
        }

        function showTimeline(crop) {
            document.getElementById('timelineCropName').textContent = crop.name + " Plan";
            const steps = document.getElementById('timelineSteps');
            steps.innerHTML = crop.timeline.map((s, i) => `
                <div class="relative pl-12">
                    <div class="absolute left-0 top-1 w-8 h-8 ${i === 0 ? 'bg-green-600 shadow-lg shadow-green-100' : 'bg-slate-200'} rounded-full border-4 border-white flex items-center justify-center text-white text-xs font-bold">${i + 1}</div>
                    <h4 class="font-bold text-slate-800">${s.task}</h4>
                    <p class="text-slate-500 text-sm">Recommended action for optimal ${crop.name} yield.</p>
                </div>
            `).join('');
            showModal('timelineModal');
        }

        function confirmPlan() {
            const btn = event.target;
            btn.textContent = "Saving to Calendar...";
            setTimeout(() => {
                alert("Great choice! üåæ We've set up reminders for your farming schedule.");
                closeModal('timelineModal');
                closeModal('planModal');
                btn.textContent = "Yes, I'll grow this! üåæ";
            }, 100);
        }

        // --- SECTION LOGIC ---
        function showSection(section) {
            if (section === 'profile') {
                document.getElementById('dashboardSection').classList.add('hidden');
                document.getElementById('profileSection').classList.remove('hidden');
            } else {
                document.getElementById('profileSection').classList.add('hidden');
                document.getElementById('dashboardSection').classList.remove('hidden');
            }
            window.scrollTo(0, 0);
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
    <!-- Fertilizer Modal -->
    <div id="fertilizerModal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm overflow-y-auto">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 duration-300 my-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-slate-800">Smart Fertilizer Plan üß™</h3>
                <button onclick="closeModal('fertilizerModal')"
                    class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>

            <div id="fertilizerForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Crop
                        Name</label>
                    <input type="text" id="fertCropName" placeholder="e.g. Wheat, Rice, Cotton"
                        class="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-green-400 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Soil
                            Type</label>
                        <select id="fertSoilType"
                            class="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none">
                            <option value="Black">Black Soil</option>
                            <option value="Red">Red Soil</option>
                            <option value="Alluvial">Alluvial Soil</option>
                            <option value="Clay">Clay Soil</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Land Size
                            (Acres)</label>
                        <input type="number" id="fertLandSize" value="1"
                            class="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Growth
                        Stage</label>
                    <select id="fertGrowthStage"
                        class="w-full p-4 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none">
                        <option value="Sowing">Sowing (Basal Dose)</option>
                        <option value="Vegetative">Vegetative (Growth)</option>
                        <option value="Flowering">Flowering</option>
                        <option value="Fruiting">Fruiting</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 py-2">
                    <input type="checkbox" id="fertOrganic" class="w-5 h-5 text-green-600 rounded focus:ring-green-500">
                    <label for="fertOrganic" class="font-bold text-slate-600 text-sm">Prefer Organic Only</label>
                </div>

                <button onclick="getFertilizerPlan()"
                    class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-2xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">
                    Generate Recommendation ‚ö°
                </button>
            </div>

            <!-- Loading State -->
            <div id="fertLoading" class="hidden text-center py-10 space-y-4">
                <div class="animate-spin text-4xl">üß™</div>
                <p class="text-slate-500 font-bold">AI Analyzing Soil & Nutrients...</p>
            </div>

            <!-- Results -->
            <div id="fertResult" class="hidden space-y-6 mt-6 pt-6 border-t border-slate-100">
                <div class="p-4 bg-green-50 rounded-2xl border border-green-100">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-green-800">Recommended Plan</h4>
                        <span
                            class="text-xs font-bold bg-white text-green-600 px-2 py-1 rounded-lg border border-green-100"
                            id="fertYieldBadge">Yield +15%</span>
                    </div>
                    <div id="fertScheduleList" class="space-y-3">
                        <!-- Dynamic Content -->
                    </div>
                    <div class="mt-4 pt-3 border-t border-green-200 flex justify-between items-center">
                        <span class="text-xs font-bold text-green-600 uppercase">Est. Cost</span>
                        <span class="text-xl font-bold text-green-700" id="fertTotalCost">‚Çπ0</span>
                    </div>
                </div>

                <div id="fertTips" class="space-y-2">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Expert Tips</p>
                    <ul class="text-xs text-slate-500 space-y-1 list-disc pl-4" id="fertTipsList"></ul>
                </div>

                <button
                    onclick="document.getElementById('fertResult').classList.add('hidden'); document.getElementById('fertilizerForm').classList.remove('hidden');"
                    class="w-full py-3 bg-slate-100 text-slate-600 font-bold rounded-xl mt-4">
                    Start New Plan
                </button>
            </div>
        </div>
    </div>

    <script>
        async function getFertilizerPlan() {
            const crop = document.getElementById('fertCropName').value;
            if (!crop) return alert("Please enter a crop name");

            document.getElementById('fertilizerForm').classList.add('hidden');
            document.getElementById('fertLoading').classList.remove('hidden');
            document.getElementById('fertResult').classList.add('hidden');

            try {
                // Determine API Base URL with fallback
                let baseUrl = 'http://127.0.0.1:5001';

                // Try to use globally defined ML_URL if available
                if (typeof ML_URL !== 'undefined') {
                    baseUrl = ML_URL;
                } else if (typeof window.location !== 'undefined' && window.location.hostname) {
                    // Construct based on current host
                    baseUrl = `http://${window.location.hostname}:5001`;
                }

                console.log("Fetching Fertilizer Plan from:", `${baseUrl}/fertilizer/recommend`);

                const response = await fetch(`${baseUrl}/fertilizer/recommend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        crop_name: crop,
                        soil_type: document.getElementById('fertSoilType').value,
                        land_size: parseFloat(document.getElementById('fertLandSize').value),
                        growth_stage: document.getElementById('fertGrowthStage').value,
                        prefer_organic: document.getElementById('fertOrganic').checked
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) throw new Error(data.error);

                renderFertilizerPlan(data);

                document.getElementById('fertLoading').classList.add('hidden');
                document.getElementById('fertResult').classList.remove('hidden');
            } catch (e) {
                console.error("Fertilizer Fetch Error:", e);
                alert(`‚ö†Ô∏è Connection Error: ${e.message}\n\nPlease ensure the ML Service is running on Port 5001.`);
                document.getElementById('fertilizerForm').classList.remove('hidden');
                document.getElementById('fertLoading').classList.add('hidden');
            }
        }

        function renderFertilizerPlan(data) {
            const list = document.getElementById('fertScheduleList');
            const totalCostEl = document.getElementById('fertTotalCost');
            const yieldBadge = document.getElementById('fertYieldBadge');
            const tipsList = document.getElementById('fertTipsList');

            if (!data.fertilizer_plan || data.fertilizer_plan.length === 0) {
                list.innerHTML = '<p class="text-sm text-slate-500 text-center py-4">No specific fertilizer needed for this criteria.</p>';
                return;
            }

            // 1. Group by Stage
            const grouped = {};
            data.fertilizer_plan.forEach(item => {
                if (!grouped[item.stage]) grouped[item.stage] = [];
                grouped[item.stage].push(item);
            });

            // 2. Build HTML
            let html = '';

            // Timeline Header
            html += `
            <div class="mb-6 px-1">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">YOUR FERTILIZATION TIMELINE</p>
                <div class="relative flex items-center justify-between px-2">
                    <div class="absolute left-0 right-0 top-1/2 h-0.5 bg-slate-100 -z-10"></div>
                    ${Object.keys(grouped).map((stage, i) => `
                        <div class="flex flex-col items-center gap-1 bg-white px-1">
                            <div class="w-3 h-3 rounded-full ${i === 0 ? 'bg-green-500 ring-4 ring-green-100' : 'bg-slate-200'}"></div>
                            <span class="text-[9px] font-bold ${i === 0 ? 'text-green-600' : 'text-slate-400'} uppercase">${stage.split(' ')[0]}</span>
                        </div>
                    `).join('')}
                    <div class="flex flex-col items-center gap-1 bg-white px-1">
                        <div class="w-3 h-3 rounded-full bg-slate-200"></div>
                        <span class="text-[9px] font-bold text-slate-400 uppercase">Harvest</span>
                    </div>
                </div>
            </div>`;

            // Render Stages
            Object.keys(grouped).forEach((stage, index) => {
                const items = grouped[stage];
                const isActionable = index === 0; // Assumption for now
                const stageDate = index === 0 ? "Today" : `In ${index * 25} days`; // Rough estimate if explicit dates are missing

                html += `
                <div class="border border-slate-100 rounded-2xl overflow-hidden mb-4 shadow-sm">
                    <!-- Stage Header -->
                    <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                        <div>
                            <h4 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                ${isActionable ? '‚úÖ' : 'üïê'} ${stage}
                            </h4>
                            <p class="text-xs text-slate-400 mt-0.5">${stageDate}</p>
                        </div>
                        ${isActionable ? '<span class="text-[10px] font-bold bg-green-100 text-green-700 px-2 py-1 rounded-md animate-pulse">ACTION NOW</span>' : ''}
                    </div>

                    <!-- Fertilizers in this stage -->
                    <div class="divide-y divide-slate-50">
                        ${items.map(item => `
                            <div class="p-4 bg-white group">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h5 class="font-bold text-slate-800">${item.fertilizer}</h5>
                                        <p class="text-xs text-slate-500">${item.application_method}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-slate-800 text-sm">${item.quantity_kg} kg</p>
                                        <p class="text-[10px] text-slate-400">Total Cost: ‚Çπ${item.cost}</p>
                                    </div>
                                </div>
                                
                                <!-- Collapsible Details -->
                                <details class="text-xs text-slate-500 mt-2">
                                    <summary class="cursor-pointer font-bold text-green-600 select-none list-none flex items-center gap-1 mb-2">
                                        <span>Show Instructions & Nutrients</span>
                                        <span class="text-[9px]">‚ñº</span>
                                    </summary>
                                    <div class="pl-2 border-l-2 border-green-100 space-y-2 py-1">
                                        <div>
                                            <p class="font-bold text-slate-400 uppercase text-[9px]">Values per Acre</p>
                                            <p>${item.quantity_per_acre ? item.quantity_per_acre + ' kg/acre' : 'N/A'}</p>
                                        </div>
                                        ${item.instructions ? `
                                        <div>
                                            <p class="font-bold text-slate-400 uppercase text-[9px]">How to Apply</p>
                                            <p class="leading-relaxed">${item.instructions}</p>
                                        </div>` : ''}
                                        ${item.npk_provided ? `
                                        <div>
                                            <p class="font-bold text-slate-400 uppercase text-[9px]">Nutrients Provided</p>
                                            <div class="flex gap-2 mt-1">
                                                <span class="bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded">N: ${item.npk_provided.N}kg</span>
                                                <span class="bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded">P: ${item.npk_provided.P}kg</span>
                                                <span class="bg-purple-50 text-purple-600 px-1.5 py-0.5 rounded">K: ${item.npk_provided.K}kg</span>
                                            </div>
                                        </div>` : ''}
                                    </div>
                                </details>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            });

            // Nearby Dealers (Mock Data)
            html += `
            <div class="mt-6 pt-6 border-t border-slate-100">
                 <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">üè™ BUY NEARBY</p>
                 <div class="space-y-2">
                    <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                        <div>
                            <p class="font-bold text-slate-700 text-sm">Ramesh Agro Store</p>
                            <p class="text-xs text-slate-500">üìç 2.3 km away ‚Ä¢ ‚≠ê 4.5</p>
                        </div>
                        <button class="bg-white text-green-600 text-xs font-bold px-3 py-2 rounded-lg shadow-sm border border-slate-100">Call</button>
                    </div>
                     <div class="bg-slate-50 p-3 rounded-xl flex justify-between items-center">
                        <div>
                            <p class="font-bold text-slate-700 text-sm">Kisan Seva Kendra</p>
                            <p class="text-xs text-slate-500">üìç 4.1 km away ‚Ä¢ ‚≠ê 4.2</p>
                        </div>
                        <button class="bg-white text-green-600 text-xs font-bold px-3 py-2 rounded-lg shadow-sm border border-slate-100">Call</button>
                    </div>
                 </div>
            </div>`;

            // Export Actions
            html += `
            <div class="grid grid-cols-2 gap-2 mt-4">
                <button class="py-3 bg-slate-800 text-white font-bold rounded-xl text-sm flex items-center justify-center gap-2">
                    <span>üìÖ</span> Add to Calendar
                </button>
                <button class="py-3 bg-green-50 text-green-700 font-bold rounded-xl text-sm flex items-center justify-center gap-2 border border-green-100">
                    <span>üí¨</span> Share Plan
                </button>
            </div>`;

            list.innerHTML = html;
            totalCostEl.innerText = `‚Çπ${data.total_cost}`;
            yieldBadge.innerText = `Yield +${data.expected_yield_increase}%`;
            tipsList.innerHTML = data.tips.map(t => `<li class="pl-1">${t}</li>`).join('');
        }
    </script>
</body>

<!-- Market Planner Modal üöú -->
<div id="marketPlannerModal"
    class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
    <div
        class="bg-white w-full max-w-4xl rounded-[2.5rem] p-8 shadow-2xl animate-in zoom-in-95 duration-300 h-[85vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="text-2xl font-bold text-slate-800">Farm-to-Market Planner üöú</h3>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">AI Harvest & Profit
                    Optimization</p>
            </div>
            <button onclick="closeModal('marketPlannerModal')"
                class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Inputs -->
            <div class="lg:col-span-1 space-y-6">
                <div class="space-y-4 bg-slate-50 p-6 rounded-3xl border border-slate-100">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Select
                            Crop</label>
                        <select id="mpCrop"
                            class="w-full p-4 bg-white rounded-xl font-bold text-slate-700 outline-none shadow-sm border border-slate-200 focus:ring-2 focus:ring-yellow-400 cursor-pointer">
                            <option value="Soybean">Soybean</option>
                            <option value="Cotton">Cotton</option>
                            <option value="Onion">Onion</option>
                            <option value="Wheat">Wheat</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">My Land
                            Size (Acres)</label>
                        <input type="number" id="mpLand" value="5"
                            class="w-full p-4 bg-white rounded-xl font-bold text-slate-700 outline-none shadow-sm border border-slate-200 focus:ring-2 focus:ring-yellow-400">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Sowing
                            Date</label>
                        <input type="date" id="mpDate"
                            class="w-full p-4 bg-white rounded-xl font-bold text-slate-700 outline-none shadow-sm border border-slate-200 focus:ring-2 focus:ring-yellow-400">
                    </div>

                    <button onclick="calculateMarketOptimization()"
                        class="w-full py-4 bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold rounded-2xl shadow-lg shadow-yellow-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                        <span>‚ú®</span> Optimize Profit
                    </button>
                </div>
            </div>

            <!-- Right: Output Dashboard -->
            <div class="lg:col-span-2 space-y-6 hidden" id="mpResults">
                <!-- Top Metric Cards -->
                <div class="grid grid-cols-2 gap-4">
                    <div
                        class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-3xl p-6 text-white relative overflow-hidden group">
                        <div
                            class="absolute right-0 top-0 p-4 text-6xl opacity-20 group-hover:scale-110 transition-transform">
                            üìÖ</div>
                        <p class="text-[10px] font-bold text-green-100 uppercase tracking-widest mb-1">Best Harvest
                            Window</p>
                        <h3 class="text-2xl font-bold mb-1" id="mpBestDate">Oct 12 - Oct 15</h3>
                        <p class="text-xs font-medium text-green-100 bg-white/20 px-2 py-1 rounded-lg w-fit">Max Price
                            Expected</p>
                    </div>
                    <div class="bg-slate-900 rounded-3xl p-6 text-white relative overflow-hidden group">
                        <div
                            class="absolute right-0 top-0 p-4 text-6xl opacity-20 group-hover:scale-110 transition-transform">
                            üí∞</div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Projected Revenue
                        </p>
                        <h3 class="text-3xl font-bold mb-1 text-yellow-400" id="mpRevenue">‚Çπ2,45,000</h3>
                        <p class="text-xs font-medium text-slate-400">+12% vs current rate</p>
                    </div>
                </div>

                <!-- Price Trend Chart (Visual Simulation) -->
                <div class="bg-white rounded-3xl border border-slate-100 p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-slate-700">Projected Price Trend (Next 30 Days)</h4>
                        <span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded-lg">High
                            Demand</span>
                    </div>
                    <div class="h-40 flex items-end justify-between gap-1" id="mpChart">
                        <!-- Bars injected via JS -->
                    </div>
                    <div class="flex justify-between text-[10px] font-bold text-slate-400 mt-2 px-2">
                        <span>Today</span>
                        <span>+15 Days</span>
                        <span>+30 Days</span>
                    </div>
                </div>

                <!-- Recommended Market -->
                <div class="bg-yellow-50 rounded-3xl p-6 border border-yellow-100">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-xl shadow-sm">
                            üìç</div>
                        <div>
                            <p class="text-[10px] font-bold text-yellow-600 uppercase tracking-widest">Best Market to
                                Sell</p>
                            <h4 class="text-lg font-bold text-slate-800" id="mpMarket">Lasalgaon Mandi</h4>
                            <p class="text-xs font-bold text-slate-500">Distance: 45km ‚Ä¢ Rate: ‚Çπ5,200/qt</p>
                        </div>
                        <div class="ml-auto">
                            <a href="#"
                                class="px-4 py-2 bg-slate-900 text-white text-xs font-bold rounded-xl hover:bg-slate-800">Navigate
                                ‚Üó</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="mpLoading"
                class="hidden lg:col-span-2 flex flex-col items-center justify-center py-20 text-center space-y-4">
                <div class="text-5xl animate-spin">üöú</div>
                <p class="text-slate-500 font-bold">AI Analyzing Market Trends & Logistics...</p>
            </div>
        </div>
    </div>
</div>

<script>
    function calculateMarketOptimization() {
        const crop = document.getElementById('mpCrop').value;
        const land = document.getElementById('mpLand').value;

        // Show Loading
        document.getElementById('mpResults').classList.add('hidden');
        document.getElementById('mpLoading').classList.remove('hidden');

        setTimeout(() => {
            // Simulate AI Calculation
            document.getElementById('mpLoading').classList.add('hidden');
            document.getElementById('mpResults').classList.remove('hidden');

            // MOCK LOGIC based on crop
            let rate = 4500;
            let market = "Lasalgaon Mandi";
            let bestDatev = "Oct 12 - Oct 15";

            if (crop === 'Soybean') { rate = 4800; market = "Latur Mandi"; bestDatev = "Nov 5 - Nov 10"; }
            if (crop === 'Cotton') { rate = 6200; market = "Akola Mandi"; bestDatev = "Dec 1 - Dec 15"; }
            if (crop === 'Onion') { rate = 2200; market = "Lasalgaon Mandi"; bestDatev = "Next Week"; }

            const revenue = rate * (parseInt(land) * 5); // 5 quintal yield approx

            document.getElementById('mpRevenue').innerText = "‚Çπ" + revenue.toLocaleString();
            document.getElementById('mpMarket').innerText = market;
            document.getElementById('mpBestDate').innerText = bestDatev;

            // Render Chart
            const chart = document.getElementById('mpChart');
            chart.innerHTML = Array(15).fill(0).map((_, i) => {
                const h = 40 + Math.random() * 60;
                const isPeak = i === 12; // peak somewhere in future
                const color = isPeak ? 'bg-green-500' : 'bg-slate-200';
                return `<div class="w-full ${color} rounded-t-md relative group" style="height: ${h}%">
                        <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[8px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">‚Çπ${rate + (i * 10)}</div>
                     </div>`;
            }).join('');

        }, 1500);
    }

    // Set default date to today
    document.getElementById('mpDate').valueAsDate = new Date();
</script>

<div class="fixed bottom-6 right-6 z-[80]">
    <button onclick="toggleChat()"
        class="w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full shadow-2xl flex items-center justify-center cursor-pointer hover:scale-110 transition-transform group">
        <span class="text-3xl group-hover:hidden">ü§ñ</span>
        <span class="text-3xl hidden group-hover:block">üé§</span>
        <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white animate-pulse"></div>
    </button>
</div>

<!-- Chat Modal -->
<div id="aiChatModal"
    class="hidden fixed bottom-24 right-6 w-96 h-[32rem] bg-white rounded-[2rem] shadow-2xl z-[80] flex flex-col border border-slate-100 origin-bottom-right transition-all">
    <!-- Header -->
    <div class="p-4 bg-slate-50 border-b border-slate-100 rounded-t-[2rem] flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-xl">ü§ñ</div>
            <div>
                <h4 class="font-bold text-slate-800">KrishiMitra Assitant</h4>
                <span class="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded-full block w-fit">‚óè
                    Online</span>
            </div>
        </div>
        <button onclick="toggleChat()" class="text-slate-400 hover:text-slate-600">&times;</button>
    </div>

    <!-- Messages Area -->
    <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50 scroll-smooth">
        <!-- Intro Message -->
        <div class="flex items-start gap-2">
            <div class="w-8 h-8 bg-blue-100 rounded-full flex-shrink-0 flex items-center justify-center text-sm">ü§ñ
            </div>
            <div
                class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-600 border border-slate-100">
                Namaste! I am your AI Assistant. You can speak to me in Hindi or English.
                <div class="mt-2 flex gap-2">
                    <button onclick="sendQuickQuery('Weather today')"
                        class="text-xs bg-slate-100 px-2 py-1 rounded-lg hover:bg-slate-200">‚òÄÔ∏è Weather</button>
                    <button onclick="sendQuickQuery('Fertilizer for Wheat')"
                        class="text-xs bg-slate-100 px-2 py-1 rounded-lg hover:bg-slate-200">üåæ Fertilizer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Voice Activation Visualizer (Hidden by default) -->
    <div id="voiceVisualizer"
        class="hidden h-16 bg-slate-900 absolute bottom-20 left-4 right-4 rounded-xl flex items-center justify-center gap-1 z-10">
        <div class="w-1 h-3 bg-green-400 rounded-full animate-[bounce_0.8s_infinite]"></div>
        <div class="w-1 h-6 bg-green-400 rounded-full animate-[bounce_1.2s_infinite]"></div>
        <div class="w-1 h-4 bg-green-400 rounded-full animate-[bounce_0.6s_infinite]"></div>
        <div class="w-1 h-8 bg-green-400 rounded-full animate-[bounce_0.9s_infinite]"></div>
        <div class="w-1 h-5 bg-green-400 rounded-full animate-[bounce_1.1s_infinite]"></div>
        <span class="absolute text-green-400 text-xs font-bold bottom-1">Listening...</span>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t border-slate-100 bg-white rounded-b-[2rem]">
        <input type="file" id="chatPhotoInput" class="hidden" accept="image/*" onchange="handleChatPhoto(this)">
        <div class="flex gap-2">
            <button onclick="document.getElementById('chatPhotoInput').click()"
                class="w-10 h-10 bg-slate-100 text-slate-500 rounded-xl flex items-center justify-center hover:bg-slate-200">
                üì∑
            </button>
            <input type="text" id="chatInput" placeholder="Ask anything..."
                class="flex-1 bg-slate-100 rounded-xl px-4 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-100">
            <button onclick="startListening()"
                class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center hover:bg-blue-700 active:scale-95 transition-all shadow-lg shadow-blue-200">
                üé§
            </button>
            <button onclick="sendMessage()"
                class="w-10 h-10 bg-slate-100 text-slate-400 rounded-xl flex items-center justify-center hover:bg-slate-200 transition-colors"
                id="sendBtn">
                ‚û§
            </button>
        </div>
    </div>
</div>

<script>
    // Chat Logic
    function toggleChat() {
        const modal = document.getElementById('aiChatModal');
        modal.classList.toggle('hidden');
    }

    function sendQuickQuery(text) {
        document.getElementById('chatInput').value = text;
        sendMessage();
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        const messages = document.getElementById('chatMessages');

        if (sender === 'user') {
            div.className = 'flex items-end gap-2 justify-end';
            div.innerHTML = `
                    <div class="bg-blue-600 p-3 rounded-2xl rounded-tr-none shadow-md text-sm text-white max-w-[80%]">
                        ${text}
                    </div>
                `;
        } else {
            div.className = 'flex items-start gap-2';
            div.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex-shrink-0 flex items-center justify-center text-sm">ü§ñ</div>
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-600 border border-slate-100 max-w-[80%]">
                        ${text}
                    </div>
                `;
        }
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        input.value = '';

        // Send to Backend
        try {
            // Determine API Base URL with fallback
            let baseUrl = 'http://127.0.0.1:5001';
            if (typeof ML_URL !== 'undefined') baseUrl = ML_URL;

            const response = await fetch(`${baseUrl}/chat/send`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    user_id: farmer.phone || 'guest'
                })
            });

            const json = await response.json();
            if (json.success) {
                const reply = json.data.response;
                addMessage(reply, 'bot');
                speak(reply);

                if (json.data.action === 'request_photo') {
                    setTimeout(() => addMessage("üì∏ Would you like to upload a photo now? <br><button onclick=\"document.getElementById('chatPhotoInput').click()\" class='mt-2 text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200 transition-colors'>Upload Photo</button>", 'bot'), 1000);
                }
            }
        } catch (e) {
            console.error(e);
            addMessage("‚ö†Ô∏è Sorry, I'm having trouble connecting to the server.", 'bot');
        }
    }

    async function handleChatPhoto(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];
        addMessage(`üì∏ Processing photo: ${file.name}...`, 'user');

        // Simulate a small delay for "AI analysis"
        setTimeout(async () => {
            // Send a keyword to the chat to trigger the diagnosis state in backend
            document.getElementById('chatInput').value = "I am sending a photo of yellow leaves";
            sendMessage();
        }, 1500);
    }

    // --- üéôÔ∏è VOICE COPILOT (TAMIL) - WHISPER + CLAUDE + ELEVENLABS ---
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    async function toggleVoiceCopilot() {
        const btn = document.querySelector('button[onclick="startListening()"]'); // Find the current mic button
        const visualizer = document.getElementById('voiceVisualizer');

        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendVoiceToAI(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                visualizer.classList.remove('hidden');
                btn.classList.add('animate-pulse', 'bg-red-500');
            } catch (err) {
                console.error("Mic Access Denied:", err);
                alert("Please enable microphone access for Voice Copilot.");
            }
        } else {
            mediaRecorder.stop();
            isRecording = false;
            visualizer.classList.add('hidden');
            btn.classList.remove('animate-pulse', 'bg-red-500');
        }
    }

    async function sendVoiceToAI(blob) {
        addMessage("üéôÔ∏è Processing your Tamil query...", 'user');

        const formData = new FormData();
        formData.append('audio', blob, 'voice.webm');

        try {
            let baseUrl = typeof ML_URL !== 'undefined' ? ML_URL : 'http://127.0.0.1:5001';
            const response = await fetch(`${baseUrl}/voice/chat`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                addMessage(result.ai_text, 'bot');
                // Play high-quality ElevenLabs voice
                playAIVoice(result.audio_b64);
            } else {
                addMessage("‚ö†Ô∏è Sorry, I couldn't understand that. Please try again.", 'bot');
            }
        } catch (err) {
            console.error("Voice Chat Error:", err);
            addMessage("‚ö†Ô∏è Voice Copilot is currently unavailable.", 'bot');
        }
    }

    function playAIVoice(base64Audio) {
        const audio = new Audio(`data:audio/mp3;base64,${base64Audio}`);
        audio.play();
    }

    // Replace the old function call with our new toggle
    function startListening() {
        toggleVoiceCopilot();
    }

    function speak(text) {
        // Fallback for non-voice chat messages
        if (!('speechSynthesis' in window)) return;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ta-IN'; // Set to Tamil
        window.speechSynthesis.speak(utterance);
    }

    // Handle enter key
    document.getElementById('chatInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });

    // ========================================
    // üìç LOCATION SETTINGS FUNCTIONS
    // ========================================

    // ========================================
    // üìç LOCATION SETTINGS FUNCTIONS (UPGRADED)
    // ========================================

    // Load saved location on page load
    function loadSavedLocation() {
        try {
            const saved = localStorage.getItem('krishimitra_location');
            if (saved) {
                const location = JSON.parse(saved);

                // Update profile display
                const displayText = location.display_name || location.city;
                document.getElementById('profileLocation').textContent = displayText;

                // Show in modal if open
                if (location.city) {
                    document.getElementById('currentLocationCity').textContent = displayText;
                    document.getElementById('currentLocationMethod').textContent =
                        location.method === 'auto' ? 'üìç Auto-detected (GPS)' : '‚úèÔ∏è Manually set';
                    document.getElementById('currentLocationDisplay').classList.remove('hidden');
                }
            } else {
                document.getElementById('profileLocation').textContent = 'Set Location';
            }
        } catch (error) {
            console.error('Error loading location:', error);
            document.getElementById('profileLocation').textContent = 'Set Location';
        }
    }

    // Select location method (auto or manual)
    function selectLocationMethod(method) {
        const autoBtn = document.getElementById('autoDetectBtn');
        const manualBtn = document.getElementById('manualEntryBtn');
        const autoContent = document.getElementById('autoDetectContent');
        const manualContent = document.getElementById('manualEntryContent');

        if (method === 'auto') {
            autoBtn.classList.add('border-green-500', 'bg-green-50');
            autoBtn.classList.remove('border-slate-200', 'bg-white');
            manualBtn.classList.remove('border-green-500', 'bg-green-50');
            manualBtn.classList.add('border-slate-200', 'bg-white');
            autoContent.classList.remove('hidden');
            manualContent.classList.add('hidden');
        } else {
            manualBtn.classList.add('border-green-500', 'bg-green-50');
            manualBtn.classList.remove('border-slate-200', 'bg-white');
            autoBtn.classList.remove('border-green-500', 'bg-green-50');
            autoBtn.classList.add('border-slate-200', 'bg-white');
            manualContent.classList.remove('hidden');
            autoContent.classList.add('hidden');
        }
    }

    // Auto-detect location using GPS + Nominatim Reverse Geocoding
    async function detectLocation() {
        const btn = document.getElementById('detectBtn');

        btn.textContent = 'üîÑ Accessing Satellites...';
        btn.disabled = true;

        if (!navigator.geolocation) {
            showLocationMessage('‚ö†Ô∏è Geolocation is not supported by your browser.', 'error');
            btn.textContent = 'üìç Detect My Location';
            btn.disabled = false;
            return;
        }

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                btn.textContent = 'üîé Finding Village Name...';

                try {
                    // Use OpenStreetMap Nominatim for Reverse Geocoding
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`);
                    if (!response.ok) throw new Error("Location Service Error");

                    const data = await response.json();

                    // Extract best name (Village, Town, or City)
                    const addr = data.address;
                    const city = addr.village || addr.town || addr.city || addr.county || "Unknown Location";
                    const state = addr.state || "";
                    const displayName = `${city}, ${state}`;

                    const locationData = {
                        latitude: lat,
                        longitude: lon,
                        city: city,
                        state: state,
                        display_name: displayName,
                        method: 'auto',
                        savedAt: new Date().toISOString()
                    };

                    localStorage.setItem('krishimitra_location', JSON.stringify(locationData));

                    showLocationMessage(`‚úÖ Location Found: ${displayName}`, 'success');

                    // Instant Update
                    setTimeout(() => refreshAppLocation(), 1000);

                } catch (error) {
                    console.error('Error fetching address:', error);
                    // Fallback if API fails
                    const locationData = {
                        latitude: lat,
                        longitude: lon,
                        city: "Current Location",
                        state: "",
                        display_name: `Lat: ${lat.toFixed(2)}, Lon: ${lon.toFixed(2)}`,
                        method: 'auto',
                        savedAt: new Date().toISOString()
                    };
                    localStorage.setItem('krishimitra_location', JSON.stringify(locationData));
                    showLocationMessage('‚ö†Ô∏è GPS found, but address name unavailable.', 'success');
                    setTimeout(() => refreshAppLocation(), 1000);
                }

                btn.textContent = 'üìç Detect My Location';
                btn.disabled = false;
            },
            (error) => {
                let message = '‚ö†Ô∏è Unable to get location. ';
                switch (error.code) {
                    case error.PERMISSION_DENIED: message += 'Please ALLOW location permission in browser settings.'; break;
                    case error.POSITION_UNAVAILABLE: message += 'GPS Signal weak or unavailable.'; break;
                    case error.TIMEOUT: message += 'Request timed out.'; break;
                }
                showLocationMessage(message, 'error');
                btn.textContent = 'üìç Detect My Location';
                btn.disabled = false;
            }
        );
    }

    // Save manual location using Nominatim Search
    async function saveManualLocation() {
        const cityInput = document.getElementById('manualCity');
        const btn = document.getElementById('saveLocationBtn');
        const query = cityInput.value.trim();

        if (!query) {
            showLocationMessage('‚ö†Ô∏è Please enter a Village, Town or City name.', 'error');
            return;
        }

        btn.textContent = 'üîé Searching India Database...';
        btn.disabled = true;

        try {
            // Search API
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, India&limit=1`);

            if (!response.ok) throw new Error("Search Service Error");

            const results = await response.json();

            if (results.length === 0) {
                showLocationMessage(`‚ùå Location "${query}" not found in India. Check spelling.`, 'error');
                btn.textContent = 'üíæ Save Location';
                btn.disabled = false;
                return;
            }

            const bestMatch = results[0];
            const displayName = bestMatch.display_name.split(',').slice(0, 2).join(','); // Shorten name

            const locationData = {
                latitude: parseFloat(bestMatch.lat),
                longitude: parseFloat(bestMatch.lon),
                city: displayName.split(',')[0], // Use first part as city
                display_name: displayName,
                method: 'manual',
                savedAt: new Date().toISOString()
            };

            localStorage.setItem('krishimitra_location', JSON.stringify(locationData));

            showLocationMessage(`‚úÖ Found: ${displayName}`, 'success');

            // Instant Update
            setTimeout(() => refreshAppLocation(), 1000);

        } catch (error) {
            console.error(error);
            showLocationMessage('‚ö†Ô∏è Search failed. Check internet connection.', 'error');
        }

        btn.textContent = 'üíæ Search & Save Location';
        btn.disabled = false;
    }

    // Clear saved location
    function clearLocation() {
        localStorage.removeItem('krishimitra_location');
        document.getElementById('currentLocationDisplay').classList.add('hidden');
        document.getElementById('profileLocation').textContent = 'Set Location';
        showLocationMessage('‚úÖ Location cleared.', 'success');
        setTimeout(() => refreshAppLocation(), 1000);
    }

    // Central Function to Refresh All Location-Dependent Data
    function refreshAppLocation() {
        closeModal('locationSettingsModal');
        loadSavedLocation();
        updateWeatherUI();
        populateMarketNews();
        // Add visual feedback
        const weatherCard = document.querySelector('#dashboardSection > div[onclick="showModal(\'weatherModal\')"]');
        if (weatherCard) {
            weatherCard.classList.add('ring-4', 'ring-green-400');
            setTimeout(() => weatherCard.classList.remove('ring-4', 'ring-green-400'), 1000);
        }
    }

    // Show message
    function showLocationMessage(message, type) {
        const messageDiv = document.getElementById('locationMessage');
        messageDiv.textContent = message;
        messageDiv.className = `mt-4 p-4 rounded-xl ${type === 'success' ? 'bg-green-50 text-green-800 border-l-4 border-green-500' :
            'bg-red-50 text-red-800 border-l-4 border-red-500'
            }`;
        messageDiv.classList.remove('hidden');

        setTimeout(() => {
            messageDiv.classList.add('hidden');
        }, 5000);
    }

    // ========================================
    // ‚òÄÔ∏è WEATHER WIDGET LOGIC (NEW)
    // ========================================

    async function updateWeatherUI() {
        try {
            const saved = localStorage.getItem('krishimitra_location');
            if (!saved) return; // Keep default if no location

            const location = JSON.parse(saved);
            const lat = location.latitude;
            const lon = location.longitude;
            const cityName = location.city || location.display_name.split(',')[0];

            // Update City Name immediately
            document.getElementById('weatherCity').textContent = `Live Weather - ${cityName}`;

            // Fetch Live Weather from OpenMeteo (Free, No Key)
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);

            if (!response.ok) throw new Error("Weather API Error");

            const data = await response.json();
            const current = data.current;
            const daily = data.daily;

            // Map WMO codes to Icons & Desc
            const weatherMap = {
                0: { icon: '‚òÄÔ∏è', text: 'Clear Sky', tip: 'Great day for field work!' },
                1: { icon: 'üå§Ô∏è', text: 'Mainly Clear', tip: 'Good conditions for sowing.' },
                2: { icon: '‚õÖ', text: 'Partly Cloudy', tip: 'Watch for afternoon changes.' },
                3: { icon: '‚òÅÔ∏è', text: 'Overcast', tip: 'Low sunlight today.' },
                45: { icon: 'üå´Ô∏è', text: 'Foggy', tip: 'Drive tractor carefully.' },
                51: { icon: 'zzDRIZZLE', text: 'Light Drizzle', tip: 'Avoid pesticide spraying.' },
                61: { icon: 'üåßÔ∏è', text: 'Rain', tip: 'Pause irrigation.' },
                71: { icon: '‚ùÑÔ∏è', text: 'Snow', tip: 'Protect young saplings.' },
                95: { icon: '‚õàÔ∏è', text: 'Thunderstorm', tip: 'Stay indoors! Safety first.' }
            };

            // Helper to get icon
            const getWMO = (code) => {
                // approximate ranges
                if (code <= 1) return weatherMap[0];
                if (code <= 2) return weatherMap[2];
                if (code <= 3) return weatherMap[3];
                if (code <= 48) return weatherMap[45];
                if (code <= 57) return weatherMap[51];
                if (code <= 67) return weatherMap[61];
                if (code <= 77) return weatherMap[71];
                return weatherMap[95];
            };

            const w = getWMO(current.weather_code);

            // Update DOM
            document.getElementById('weatherTemp').textContent = `${Math.round(current.temperature_2m)}¬∞C`;
            document.getElementById('weatherIcon').textContent = w.icon;
            document.getElementById('weatherDesc').textContent = w.text;
            document.getElementById('weatherTips').textContent = w.tip;

            // Update Forecast (Next 3 Days)
            const forecastGrid = document.getElementById('weatherForecastGrid');
            if (forecastGrid && daily) {
                let forecastHTML = '';
                // We skip index 0 (Today) and show 1, 2, 3 (Tomorrow, etc.)
                for (let i = 1; i <= 3; i++) {
                    const date = new Date(daily.time[i]);
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' }); // Mon, Tue
                    const maxTemp = Math.round(daily.temperature_2m_max[i]);
                    const weatherCode = daily.weather_code[i];
                    const wmo = getWMO(weatherCode);

                    forecastHTML += `
                        <div class="text-center">
                            <p class="text-[10px] md:text-xs text-blue-200 uppercase font-bold tracking-wider mb-1 md:mb-2">${i === 1 ? 'Tomorrow' : dayName}</p>
                            <p class="text-lg md:text-xl font-bold">${maxTemp}¬∞C</p>
                            <p class="text-lg">${wmo.icon}</p>
                        </div>
                    `;
                }
                forecastGrid.innerHTML = forecastHTML;
            }

            // Update Full 7-Day Forecast Modal
            const modalList = document.getElementById('weatherModalList');
            if (modalList && daily) {
                let modalHTML = '';
                for (let i = 0; i < daily.time.length; i++) {
                    const date = new Date(daily.time[i]);
                    const dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'long' });
                    const maxTemp = Math.round(daily.temperature_2m_max[i]);
                    const minTemp = Math.round(daily.temperature_2m_min[i]);
                    const weatherCode = daily.weather_code[i];
                    const wmo = getWMO(weatherCode);

                    // Highlight Rain or Bad Weather
                    const isRainy = weatherCode >= 51 && weatherCode <= 67; // Drizzle or Rain
                    const isStormy = weatherCode >= 95;
                    const bgClass = (isRainy || isStormy) ? 'bg-blue-50/50 border-2 border-blue-200' : 'bg-slate-50';
                    const textClass = (isRainy || isStormy) ? 'text-blue-800' : 'text-slate-700';

                    modalHTML += `
                        <div class="flex justify-between items-center p-4 rounded-2xl ${bgClass}">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${wmo.icon}</span>
                                <div>
                                    <p class="font-bold ${textClass}">${dayName}</p>
                                    <p class="text-xs ${textClass} opacity-80">${wmo.text}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold ${textClass} text-lg block">${maxTemp}¬∞C</span>
                                <span class="text-[10px] text-slate-400 font-bold">${minTemp}¬∞C</span>
                            </div>
                        </div>
                     `;
                }

                // Add Advisory at bottom if rain detected
                const rainDay = daily.weather_code.findIndex(c => c >= 51); // First rainy day
                if (rainDay !== -1) {
                    const date = new Date(daily.time[rainDay]);
                    const dayName = rainDay === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'long' });
                    modalHTML += `<p class="text-xs text-blue-600 font-bold text-center mt-4 bg-blue-50 py-2 rounded-xl border border-blue-100">‚ö†Ô∏è Rain Expected on ${dayName}. Plan accordingly!</p>`;
                }
                modalList.innerHTML = modalHTML;
            }

        } catch (error) {
            console.error("Weather Update Failed:", error);
        }
    }

    // ========================================
    // üí∞ MARKET & NEWS LOGIC (NEW)
    // ========================================

    function populateMarketNews() {
        // 1. Get Location
        const saved = localStorage.getItem('krishimitra_location');
        let city = "Nashik"; // Default
        if (saved) {
            const loc = JSON.parse(saved);
            city = loc.city || loc.display_name.split(',')[0];
        }

        // Update Header
        const header = document.querySelector('#marketModal h3 + p');
        if (header) header.textContent = `Live Mandi Prices ‚Ä¢ ${city}`; // e.g. Live Mandi Prices ‚Ä¢ Melur

        // 2. Generate Real-looking Market Prices
        const crops = [
            { name: "Tomato (Local)", base: 2500 },
            { name: "Onion (Red)", base: 1800 },
            { name: "Potato (Jyoti)", base: 1200 },
            { name: "Cotton (Hybrid)", base: 6200 },
            { name: "Soybean (Yellow)", base: 4800 },
            { name: "Wheat (Lokwan)", base: 2300 }
        ];

        const priceGrid = document.getElementById('mandiPricesGrid');
        if (priceGrid) {
            let html = '';
            crops.forEach(crop => {
                // Randomize price slightly (+/- 5%) to look real
                const variation = Math.floor(Math.random() * 200) - 100;
                const price = crop.base + variation;
                const isUp = variation > 0;
                const trendIcon = isUp ? 'text-green-600' : 'text-red-500';
                const arrow = isUp ? '‚ñ≤' : '‚ñº';

                html += `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center">
                        <div>
                            <p class="text-sm font-bold text-slate-700">${crop.name}</p>
                            <p class="text-xs text-slate-400">Low: ‚Çπ${price - 100} ‚Ä¢ High: ‚Çπ${price + 150}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-slate-800">‚Çπ${price}/q</p>
                            <p class="text-[10px] font-bold ${trendIcon}">${arrow} ${(Math.random() * 2).toFixed(1)}%</p>
                        </div>
                    </div>
                `;
            });
            priceGrid.innerHTML = html;
        }

        // 3. Generate Local News (Using Real Date)
        const newsList = document.getElementById('marketNewsList');
        if (newsList) {
            const today = new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });

            const newsItems = [
                {
                    title: `Bumper harvest expected in ${city} region this season.`,
                    source: "AgriNews India",
                    time: "2 hours ago"
                },
                {
                    title: "Govt announces new subsidy for drip irrigation systems.",
                    source: "Ministry of Agriculture",
                    time: "5 hours ago"
                },
                {
                    title: "Global cotton prices surge by 5% due to high demand.",
                    source: "Market Watch",
                    time: "Yesterday"
                },
                {
                    title: `Local ${city} mandi reports record arrival of soybeans.`,
                    source: "Mandi Samachar",
                    time: `Today, ${today}`
                }
            ];

            newsList.innerHTML = newsItems.map(news => `
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h5 class="font-bold text-slate-800 text-sm mb-1 line-clamp-2">${news.title}</h5>
                    <div class="flex justify-between items-center text-[10px] text-slate-500 font-medium">
                        <span>üì∞ ${news.source}</span>
                        <span>üïí ${news.time}</span>
                    </div>
                </div>
            `).join('');
        }
    }

    // Load ALL Data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadSavedLocation();
        updateWeatherUI();
        populateMarketNews(); // Run this!
    });
</script>
</body>

</html>